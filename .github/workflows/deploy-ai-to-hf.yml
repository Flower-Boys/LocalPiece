name: Deploy AI to Hugging Face Hub

on:
  push:
    branches:
      - AI
    paths:
      - "AI/**"
      - ".github/workflows/deploy-ai-to-hf.yml"

jobs:
  deploy-to-hf-space:
    runs-on: ubuntu-latest
    steps:
      # 1. ìš°ë¦¬ GitHub ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      # lfs: true ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ LFSë¡œ ê´€ë¦¬ë˜ëŠ” íŒŒì¼ì„ ì‹¤ì œ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # 2. Hugging Faceì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ Git ì¸ì¦ ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Configure Git for Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: git config --global url."https://Min9yu:${HF_TOKEN}@huggingface.co".insteadOf "https://huggingface.co"

      # 3. Hugging Face Space ì €ì¥ì†Œë¥¼ 'hf-space'ë¼ëŠ” ì´ë¦„ì˜ í´ë”ì— í´ë¡ í•©ë‹ˆë‹¤.
      - name: Clone Hugging Face space
        run: git clone https://huggingface.co/spaces/Min9yu/localpiece-ai-generator hf-space

      # 4. ìš°ë¦¬ ì €ì¥ì†Œì˜ AI/ í´ë” ë‚´ìš©ì„ hf-space í´ë”ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.
      - name: Sync AI directory to HF space
        run: rsync -av --delete --exclude='.git/' AI/ hf-space/

      # 5. hf-space í´ë”ë¡œ ì´ë™í•˜ì—¬ Git LFSë¥¼ ì„¤ì •í•˜ê³  ëŒ€ìš©ëŸ‰ íŒŒì¼ì„ ì¶”ì í•©ë‹ˆë‹¤.
      - name: Set up Git LFS in target repository
        run: |
          cd hf-space
          git lfs install
          # AI ëª¨ë¸ ê°€ì¤‘ì¹˜ íŒŒì¼ë“¤ì„ LFSë¡œ ì¶”ì í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
          git lfs track "*.pth.tar"
          git lfs track "*.pt"
          # LFS ì„¤ì •ì„ ë‹´ê³  ìˆëŠ” .gitattributes íŒŒì¼ì„ Gitì— ì¶”ê°€í•©ë‹ˆë‹¤.
          git add .gitattributes

      # 6. ë³€ê²½ì‚¬í•­ì„ Hugging Face ì €ì¥ì†Œì— pushí•©ë‹ˆë‹¤.
      - name: Push to Hugging Face Hub
        run: |
          cd hf-space
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "ğŸš€ Auto-deploy from main repo, setting up LFS"
            git push origin main
          else
            echo "No changes to deploy."
          fi